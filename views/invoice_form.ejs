<!DOCTYPE html>
<html>
<head>
  <title>Create Invoice</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="/images/logo.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <img src="/images/logo.png" alt="Company Logo" class="logo">
    </div>
    <div class="header-right">
      <h1>INVOICE FORM</h1>
    </div>
  </header>

  <main class="container">
    <form action="/generate/invoice" method="POST" enctype="application/x-www-form-urlencoded" target="_blank">
      <div class="customer-info">
        <div class="title">
          <h2>Customer Info</h2>
        </div>

        <div class="input-customer-details">
          <label>Invoice Number</label>
          <input type="text" name="invoice_number" placeholder="01" required>

          <label>Nama</label>
          <input type="text" name="customer_name" placeholder="Baba" required>

          <label>No. Telepon</label>
          <input type="text" name="phone" placeholder="08123456789" required>

          <label>Alamat</label>
          <textarea name="address" rows="3" placeholder="Jl. Raya No. 1" required></textarea>

          <label>Opsi Pengiriman</label>
          <select id="opsi_pengiriman" name="opsi_pengiriman">
            <option value="Gosend Sameday">Gosend Sameday</option>
            <option value="Gosend Instant">Gosend Instant</option>
            <option value="Paxel Sameday">Paxel Sameday</option>
            <option value="Paxel Nextday">Paxel Nextday</option>
          </select>

          <label>Tanggal Pengiriman</label>
          <input type="date" name="delivery_date">
        </div>
        
      </div>
      
      <h2>Produk</h2>
      <div id="products-container">
        <div class="product-row">
          <select name="product_name[]" class="product-select" required>
            <option value="">-- Pilih Produk --</option>
            <option value="Japanese Wagyu A5 Ribeye Steak Cut 400 gram">Japanese Wagyu A5 Ribeye Steak Cut 400 gram</option>
            <option value="Japanese Wagyu A5 Ribeye Steak Cut 450 gram">Japanese Wagyu A5 Ribeye Steak Cut 450 gram</option>
            <option value="Japanese Wagyu A5 Ribeye Steak Cut 500 gram">Japanese Wagyu A5 Ribeye Steak Cut 500 gram</option>
            <option value="Japanese Wagyu A5 Ribeye Yakiniku Cut (200 gr)">Japanese Wagyu A5 Ribeye Yakiniku Cut (200 gr)</option>
            <option value="Japanese Wagyu A5 Ribeye Yakiniku Cut (100 gr)">Japanese Wagyu A5 Ribeye Yakiniku Cut (100 gr)</option>
            <option value="Japanese Wagyu A5 Ribeye Slice Cut (200 gr)">Japanese Wagyu A5 Ribeye Slice Cut (200 gr)</option>
            <option value="Japanese Wagyu A5 Ribeye Slice Cut (100 gr)">Japanese Wagyu A5 Ribeye Slice Cut (100 gr)</option>

            <option value="Japanese Wagyu A5 Sirloin Steak Cut 200 gram">Japanese Wagyu A5 Sirloin Steak Cut 200 gram</option>
            <option value="Japanese Wagyu A5 Sirloin Steak Cut 250 gram">Japanese Wagyu A5 Sirloin Steak Cut 250 gram</option>
            <option value="Japanese Wagyu A5 Sirloin Steak Cut 300 gram">Japanese Wagyu A5 Sirloin Steak Cut 300 gram</option>
            <option value="Japanese Wagyu A5 Sirloin Yakiniku Cut (200 gr)">Japanese Wagyu A5 Sirloin Yakiniku Cut (200 gr)</option>
            <option value="Japanese Wagyu A5 Sirloin Yakiniku Cut (100 gr)">Japanese Wagyu A5 Sirloin Yakiniku Cut (100 gr)</option>
            <option value="Japanese Wagyu A5 Sirloin Slice Cut (200 gr)">Japanese Wagyu A5 Sirloin Slice Cut (200 gr)</option>
            <option value="Japanese Wagyu A5 Sirloin Slice Cut (100 gr)">Japanese Wagyu A5 Sirloin Slice Cut (100 gr)</option>

            <option value="Japanese Wagyu A5 Shortplate Slice Cut (200 gr)">Japanese Wagyu A5 Shortplate Slice Cut (200 gr)</option>
            <option value="Japanese Wagyu A5 Shortplate Slice Cut (100 gr)">Japanese Wagyu A5 Shortplate Slice Cut (100 gr)</option>

            <option value="Japanese Wagyu A5 Budget Bundle">Japanese Wagyu A5 Budget Bundle</option>
            <option value="Japanese Wagyu A5 Slice Bundle">Japanese Wagyu A5 Slice Bundle</option>

            <option value="Japanese Wagyu A5 Steak Combo 1">Japanese Wagyu A5 Steak Combo 1</option>
            <option value="Japanese Wagyu A5 Steak Combo 2">Japanese Wagyu A5 Steak Combo 2</option>
            <option value="Japanese Wagyu A5 Weekend Special">Japanese Wagyu A5 Weekend Special</option>
            <option value="Japanese Wagyu A5 Mixed Combo">Japanese Wagyu A5 Mixed Combo</option>

            <option value="Ongkir Sameday">Ongkir Sameday</option>
            <option value="Ongkir Instant">Ongkir Instant</option>
            <option value="Ongkir Nextday">Ongkir Nextday</option>
          </select>
          <input type="number" name="qty[]" placeholder="Qty" required>
          <input type="number" name="price[]" placeholder="Harga Satuan" required>
          <button type="button" onclick="removeRow(this)">Hapus</button>
        </div>
      </div>
      <button type="button" onclick="addProductRow()">Tambah Produk</button>

      <label>Nama Diskon</label>
      <input type="text" name="discount_name" placeholder="Contoh: Promo Akhir Tahun">

      <label>Jumlah Diskon (Rp)</label>
      <input type="number" name="discount_amount" placeholder="Contoh: 50000">

      <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
        <button type="button" id="btnPreviewNote">Preview Note</button>
        <button type="button" id="btnCopyNote">Copy Note</button>
        <button type="button" id="btnOpenNote">Open Note in New Tab</button>
      </div>

      <div style="margin-top: 12px;">
        <label style="display:block; margin-bottom:6px;">Preview / Copy Text</label>
        <textarea id="noteText" rows="8" style="width:100%; font-family:monospace;"></textarea>
      </div>


      <button type="submit">Generate Invoice PDF</button>
    </form>
  </main>

  <script>
    const productPrices = {
      "Japanese Wagyu A5 Ribeye Yakiniku Cut (200 gr)": 560000,
      "Japanese Wagyu A5 Ribeye Yakiniku Cut (100 gr)": 350000,
      "Japanese Wagyu A5 Ribeye Slice Cut (200 gr)": 560000,
      "Japanese Wagyu A5 Ribeye Slice Cut (100 gr)": 299000,
      "Japanese Wagyu A5 Sirloin Yakiniku Cut (200 gr)": 560000,
      "Japanese Wagyu A5 Sirloin Yakiniku Cut (100 gr)": 350000,
      "Japanese Wagyu A5 Sirloin Slice Cut (200 gr)": 560000,
      "Japanese Wagyu A5 Sirloin Slice Cut (100 gr)": 299000,
      "Japanese Wagyu A5 Shortplate Slice Cut (200 gr)": 199000,
      "Japanese Wagyu A5 Shortplate Slice Cut (100 gr)": 119000,
      "Japanese Wagyu A5 Budget Bundle": 499000,
      "Japanese Wagyu A5 Slice Bundle": 799000,
      "Japanese Wagyu A5 Ribeye Steak Cut 400 gram": 960000,
      "Japanese Wagyu A5 Ribeye Steak Cut 450 gram": 1080000,
      "Japanese Wagyu A5 Ribeye Steak Cut 500 gram": 1200000,
      "Japanese Wagyu A5 Sirloin Steak Cut 200 gram": 560000,
      "Japanese Wagyu A5 Sirloin Steak Cut 250 gram": 700000,
      "Japanese Wagyu A5 Sirloin Steak Cut 300 gram": 840000,
      "Japanese Wagyu A5 Steak Combo 1": 999000,
      "Japanese Wagyu A5 Steak Combo 2": 1250000,
      "Japanese Wagyu A5 Weekend Special": 1999000,
      "Japanese Wagyu A5 Mixed Combo": 999000,
      
      // Steak Cuts and other items are excluded for flexibility
    };

  

    function addProductRow() {
      const container = document.getElementById('products-container');
      const row = document.createElement('div');
      row.className = 'product-row';

      // Clone the first select element
      const firstSelect = document.querySelector('.product-select');
      const newSelect = firstSelect.cloneNode(true);
      newSelect.name = "product_name[]";
      newSelect.required = true;

      // Create the other inputs and button
      const qtyInput = document.createElement('input');
      qtyInput.type = 'number';
      qtyInput.name = 'qty[]';
      qtyInput.placeholder = 'Qty';
      qtyInput.required = true;

      const priceInput = document.createElement('input');
      priceInput.type = 'number';
      priceInput.name = 'price[]';
      priceInput.placeholder = 'Harga Satuan';
      priceInput.required = true;

      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.textContent = 'Hapus';
      deleteBtn.onclick = () => removeRow(deleteBtn);

      // Append all to row
      row.appendChild(newSelect);
      row.appendChild(qtyInput);
      row.appendChild(priceInput);
      row.appendChild(deleteBtn);

      // Add to container
      container.appendChild(row);
    }

    function autofillPrice(selectElement) {
      const selected = selectElement.value;
      const priceInput = selectElement.nextElementSibling.nextElementSibling;
      if (productPrices[selected] !== undefined) {
        priceInput.value = productPrices[selected];
      } else {
        priceInput.value = '';
      }
    }

    function removeRow(button) {
      const container = document.getElementById('products-container');
      const rows = container.querySelectorAll('.product-row');
      
      if (rows.length <= 1) {
        alert("Minimal 1 produk harus ada.");
        return;
      }

      const row = button.parentElement;
      row.remove();
    }

    // Auto-attach price logic to the first default row
    document.getElementById('products-container').addEventListener('change', function (e) {
      if (e.target.classList.contains('product-select')) {
        autofillPrice(e.target);
      }
    });

     const productAlias = {
      "Japanese Wagyu A5 Ribeye Yakiniku Cut (200 gr)": "Ribeye kotak kotak 200 gram",
      "Japanese Wagyu A5 Ribeye Yakiniku Cut (100 gr)": "Ribeye kotak kotak 100 gram",
      "Japanese Wagyu A5 Ribeye Slice Cut (200 gr)": "Ribeye gulung 200 gram",
      "Japanese Wagyu A5 Ribeye Slice Cut (100 gr)": "Ribeye gulung 100 gram",
      "Japanese Wagyu A5 Sirloin Yakiniku Cut (200 gr)": "Sirloin kotak kotak 200 gram",
      "Japanese Wagyu A5 Sirloin Yakiniku Cut (100 gr)": "Sirloin kotak kotak 100 gram",
      "Japanese Wagyu A5 Sirloin Slice Cut (200 gr)": "Sirloin gulung 200 gram",
      "Japanese Wagyu A5 Sirloin Slice Cut (100 gr)": "Sirloin gulung 100 gram",
      "Japanese Wagyu A5 Slice Bundle": "Sirloin gulung 100 gram 3 pack",
      "Japanese Wagyu A5 Ribeye Steak Cut 400 gram": "Ribeye tebel 400 gram",
      "Japanese Wagyu A5 Ribeye Steak Cut 450 gram": "Ribeye tebel 450 gram",
      "Japanese Wagyu A5 Ribeye Steak Cut 500 gram": "Ribeye tebel 500 gram",
      "Japanese Wagyu A5 Sirloin Steak Cut 200 gram": "Sirloin tebel 200 gram",
      "Japanese Wagyu A5 Sirloin Steak Cut 250 gram": "Sirloin tebel 250 gram",
      "Japanese Wagyu A5 Sirloin Steak Cut 300 gram": "Sirloin tebel 300 gram",
      "Japanese Wagyu A5 Steak Combo 1": "2 pack Sirloin tebel 200 gram",
      "Japanese Wagyu A5 Steak Combo 2": "2 pack Sirloin tebel 250 gram",
      "Japanese Wagyu A5 Weekend Special": "3 pack Sirloin tebel 200 gram + 1 pack Sirloin gulung 200 gram",
      "Japanese Wagyu A5 Mixed Combo": "1 pack Sirloin tebel 200 gram + 1 pack Sirloin gulung 200 gram",
    };

    function buildAliasText() {
      const container = document.getElementById('products-container');
      const rows = container.querySelectorAll('.product-row');

      // alias → total qty
      const map = new Map();

      rows.forEach(row => {
        const sel = row.querySelector('.product-select');
        const qtyEl = row.querySelector('input[name="qty[]"]');

        const name = (sel?.value || '').trim();
        const qty = Number(qtyEl?.value || 0);
        if (!name || qty <= 0) return;

        const alias = (productAlias[name] || name).trim();
        map.set(alias, (map.get(alias) || 0) + qty);
      });

      // Build lines (sorted for consistent output)
      const lines = [];
      Array.from(map.entries())
        .sort(([a],[b]) => a.localeCompare(b))
        .forEach(([alias, qty]) => {
          // If alias already contains the word "pack", avoid "pack pack"
          const hasPackWord = /(^|\s)pack(\s|$)/i.test(alias);
          const prefix = hasPackWord ? `${qty} x` : `${qty} pack`;
          lines.push(`${prefix} ${alias.toLowerCase()}`);
        });

      // Shipping footer: "<Carrier> atas nama <Customer>"
      const opsi = document.getElementById('opsi_pengiriman')?.value || '';
      const customer = document.querySelector('input[name="customer_name"]')?.value || '';
      const carrier = (opsi.split(' ')[0] || opsi).trim(); // "Gosend"/"Paxel"/etc.

      if (carrier || customer) {
        lines.push('');
        lines.push(`${carrier} atas nama ${customer}`.trim());
      }
      lines.push(''); // blank line before the bar (optional)
      lines.push('===================');
      return lines.join('\n');
    }

    // Buttons
    document.getElementById('btnPreviewNote')?.addEventListener('click', () => {
      document.getElementById('noteText').value = buildAliasText();
    });

    document.getElementById('btnCopyNote')?.addEventListener('click', async () => {
      const text = document.getElementById('noteText').value || buildAliasText();
      try {
        await navigator.clipboard.writeText(text);
        alert('Copied!');
      } catch {
        // Fallback for older browsers
        const ta = document.getElementById('noteText');
        ta.value = text;
        ta.focus();
        ta.select();
        document.execCommand('copy');
        alert('Copied!');
      }
    });

    document.getElementById('btnOpenNote')?.addEventListener('click', () => {
      const text = document.getElementById('noteText').value || buildAliasText();
      const w = window.open('about:blank', '_blank');
      if (w) {
        const escaped = text
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;');
        w.document.write(`<pre style="font-family:monospace; white-space:pre-wrap; line-height:1.4">${escaped}</pre>`);
        w.document.close();
      }
    });

  </script>
</body>
</html>